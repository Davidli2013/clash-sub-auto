name: Auto Update Clash Sub
on:
  schedule:
    - cron: '0 0,12 * * *'  # 每天凌晨0点和中午12点（UTC时间）自动更新，对应北京时间早8点和晚8点
  workflow_dispatch:    # 允许手动触发更新

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate subscriptions with subconverter
        run: |
          # 合并所有订阅源到一个文件
          echo "mixed:" > all_subs.yaml
          while IFS= read -r url; do
            echo "  - \"$url\"" >> all_subs.yaml
          done < <(yq e '.subs[]' config.yaml)

          # 启动 subconverter 并生成4个订阅文件
          docker run --rm -v $(pwd):/workdir -w /workdir sprov0616/subconverter:latest \
            subconverter -g "https://example.com#$(cat all_subs.yaml | base64 -w 0)" \
              -f clash -o /workdir/sub_all.yaml \
              -r "香港|HK|hk" -O /workdir/sub_hk.yaml \
              -r "新加坡|SG|sg" -O /workdir/sub_sg.yaml \
              -r "日本|JP|jp" -O /workdir/sub_jp.yaml

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update clash subscriptions"
          file_pattern: 'sub_*.yaml'
