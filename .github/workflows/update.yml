name: Auto Update HK Trojan (4x/day, Real Test)
on:
  schedule:
    - cron: '0 0,6,12,18 * * *'  # åŒ—äº¬æ—¶é—´8/14/20/2ç‚¹æ›´æ–°ï¼ˆä¸€å¤©4æ¬¡ï¼‰
  workflow_dispatch:            # æ‰‹åŠ¨è§¦å‘

jobs:
  update_hk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml requests urllib3
          sudo apt update && sudo apt install -y netcat-openbsd

      - name: Generate HK Trojan (Real Speed Test)
        run: |
          cat > gen_hk.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          import subprocess
          import time
          from concurrent.futures import ThreadPoolExecutor
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # é…ç½®
          MAX_WORKERS = 10  # å¹¶å‘æ•°
          MAX_DELAY = 150   # å»¶è¿Ÿ<150ms
          TIMEOUT = 10      # è¶…æ—¶æ—¶é—´
          MAX_PROXIES = 50  # æœ€å¤šä¿ç•™50ä¸ª

          # 1. æå–æ‰€æœ‰TrojanèŠ‚ç‚¹
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg['subs']
          all_trojan = []
          seen_nodes = set()

          for url in subs:
              try:
                  r = requests.get(url, timeout=20, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              server = p.get('server', '')
                              port = p.get('port', '')
                              password = p.get('password', '')
                              node_id = f"{server}:{port}:{password}"
                              if node_id not in seen_nodes:
                                  seen_nodes.add(node_id)
                                  all_trojan.append(p)
              except:
                  continue

          # 2. ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹
          hk_nodes = []
          for p in all_trojan:
              name = p.get('name', '').lower()
              if 'é¦™æ¸¯' in name or 'hk' in name:
                  hk_nodes.append(p)
          print(f"âœ… æå–åˆ° {len(hk_nodes)} ä¸ªé¦™æ¸¯TrojanèŠ‚ç‚¹")

          # 3. çœŸå®æµ‹é€Ÿ
          def test_delay(proxy):
              try:
                  server = proxy.get('server')
                  port = proxy.get('port')
                  start = time.time()
                  result = subprocess.run(
                      f"nc -zv -w {TIMEOUT} {server} {port}",
                      shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE
                  )
                  if result.returncode == 0:
                      delay = round((time.time() - start)*1000)
                      return (proxy, delay) if delay < MAX_DELAY else (proxy, float('inf'))
                  return (proxy, float('inf'))
              except:
                  return (proxy, float('inf'))

          valid = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
              futures = [executor.submit(test_delay, p) for p in hk_nodes]
              for f in futures:
                  proxy, delay = f.result()
                  if delay < MAX_DELAY:
                      valid.append(proxy)

          # 4. æŒ‰å»¶è¿Ÿæ’åºå¹¶ä¿å­˜
          valid.sort(key=lambda x: x.get('delay', MAX_DELAY))
          final = valid[:MAX_PROXIES]
          output = {
              'proxies': final,
              'proxy-groups': [{
                  'name': 'Auto-HK-Trojan',
                  'type': 'url-test',
                  'proxies': [p['name'] for p in final],
                  'url': 'http://www.gstatic.com/generate_204',
                  'interval': 300
              }]
          }

          with open('sub_trojan_hk.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(output, f, allow_unicode=True, sort_keys=False)
          print(f"âœ… ç”Ÿæˆé¦™æ¸¯Trojanæ–‡ä»¶ï¼Œä¿ç•™ {len(final)} ä¸ªæœ‰æ•ˆèŠ‚ç‚¹")
          EOF

          python gen_hk.py

      - name: Commit HK file
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update HK Trojan (real speed test) ğŸš€"
          file_pattern: sub_trojan_hk.yaml
          commit_options: "--allow-empty"
          push_options: "--force"
