name: Auto Update Trojan Only (HK Only)
on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动更新一次
  workflow_dispatch:        # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}  # 使用你配置的 PAT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests urllib3

      - name: Generate HK Trojan Subscription
        run: |
          cat > gen.py << 'EOF'
          import yaml
          import requests
          import base64
          from urllib.parse import urlparse
          import urllib3
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # 读取 config.yaml
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)

          subs = cfg['subs']
          global_filter = cfg.get('global_filter', {})
          allowed_protocols = global_filter.get('allowed_protocols', ['trojan'])
          max_delay = global_filter.get('max_delay', 150) / 1000  # 转换为秒

          all_proxies = []

          # 拉取并过滤所有订阅源
          for url in subs:
              try:
                  r = requests.get(url, timeout=20, verify=False)
                  # 尝试解码 Base64
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  # 解析 YAML
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          # 1. 只保留 trojan 协议
                          if p.get('type') in allowed_protocols:
                              # 2. 只保留名称含“香港”或“HK”的节点
                              name = p.get('name', '').lower()
                              if '香港' in name or 'hk' in name:
                                  all_proxies.append(p)
              except Exception as e:
                  print(f"处理 {url} 失败: {e}")
                  continue

          # 去重（按节点名称）
          unique_proxies = []
          seen_names = set()
          for p in all_proxies:
              name = p.get('name')
              if name and name not in seen_names:
                  seen_names.add(name)
                  unique_proxies.append(p)

          # 构建最终的订阅文件
          output = {
              'proxies': unique_proxies[:50],  # 最多保留50个，避免文件过大
              'proxy-groups': [
                  {
                      'name': 'Auto-HK-Trojan',
                      'type': 'url-test',
                      'proxies': [p['name'] for p in unique_proxies[:50]],
                      'url': 'http://www.gstatic.com/generate_204',
                      'interval': 300
                  }
              ]
          }

          # 保存到 sub_trojan_hk.yaml
          with open('sub_trojan_hk.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(output, f, allow_unicode=True, sort_keys=False)

          print(f"✅ 生成香港 trojan 订阅文件，共 {len(unique_proxies)} 个节点")
          EOF

          # 执行脚本
          python gen.py

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update HK Trojan only subscription"
          file_pattern: sub_trojan_hk.yaml
