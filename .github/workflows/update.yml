name: Auto Update Trojan (HK/JP/SG) with Real Speed Test
on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ›´æ–°ï¼ˆå®žæµ‹è€—æ—¶çº¦5-10åˆ†é’Ÿï¼‰
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml requests urllib3 pysocks
          # å®‰è£… Trojan æµ‹é€Ÿä¾èµ–ï¼ˆUbuntu çŽ¯å¢ƒï¼‰
          sudo apt update && sudo apt install -y curl netcat-openbsd

      - name: Generate Trojan Subscriptions (Real Speed Test)
        run: |
          cat > gen.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          import subprocess
          import re
          import time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # ===================== æ ¸å¿ƒé…ç½® =====================
          MAX_WORKERS = 10  # å¹¶å‘æµ‹é€Ÿæ•°ï¼ˆåˆ«å¤ªé«˜ï¼Œé¿å…è¢«å±è”½ï¼‰
          MAX_DELAY = 150   # ä¿ç•™å»¶è¿Ÿ<150msçš„èŠ‚ç‚¹
          TIMEOUT = 10      # æ¯ä¸ªèŠ‚ç‚¹æµ‹é€Ÿè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
          MAX_PROXIES = 50  # æ¯ä¸ªåœ°åŒºæœ€å¤šä¿ç•™50ä¸ªèŠ‚ç‚¹
          # ==================================================

          # 1. è¯»å–è®¢é˜…æºå¹¶æå–æ‰€æœ‰ Trojan èŠ‚ç‚¹
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg['subs']

          all_trojan = []
          seen_nodes = set()  # åŽ»é‡æ ‡è¯†ï¼ˆæœåŠ¡å™¨+ç«¯å£+å¯†ç ï¼‰

          for url in subs:
              try:
                  r = requests.get(url, timeout=20, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              # ç”Ÿæˆå”¯ä¸€æ ‡è¯†åŽ»é‡
                              server = p.get('server', '')
                              port = p.get('port', '')
                              password = p.get('password', '')
                              node_id = f"{server}:{port}:{password}"
                              if node_id not in seen_nodes:
                                  seen_nodes.add(node_id)
                                  all_trojan.append(p)
              except Exception as e:
                  continue

          print(f"âœ… æå–å¹¶åŽ»é‡åŽï¼Œå…± {len(all_trojan)} ä¸ª Trojan èŠ‚ç‚¹")

          # 2. çœŸå®žæµ‹é€Ÿå‡½æ•°ï¼ˆæµ‹è¯• Trojan èŠ‚ç‚¹è¿žé€šæ€§å’Œå»¶è¿Ÿï¼‰
          def test_trojan_delay(proxy):
              """
              å®žæµ‹ Trojan èŠ‚ç‚¹å»¶è¿Ÿï¼š
              1. æµ‹è¯•æœåŠ¡å™¨ç«¯å£æ˜¯å¦é€š
              2. æ¨¡æ‹Ÿæ¡æ‰‹æ£€æµ‹è¿žé€šæ€§
              3. è®¡ç®—å¾€è¿”å»¶è¿Ÿ
              """
              try:
                  server = proxy.get('server')
                  port = proxy.get('port')
                  password = proxy.get('password')
                  
                  if not all([server, port, password]):
                      return (proxy, float('inf'))
                  
                  # æ­¥éª¤1ï¼šæµ‹è¯•ç«¯å£æ˜¯å¦å¼€æ”¾ï¼ˆå¿«é€Ÿæ£€æµ‹ï¼‰
                  start_time = time.time()
                  nc_cmd = f"nc -zv -w {TIMEOUT} {server} {port}"
                  result = subprocess.run(
                      nc_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE
                  )
                  if result.returncode != 0:
                      return (proxy, float('inf'))
                  
                  # æ­¥éª¤2ï¼šè®¡ç®—å»¶è¿Ÿï¼ˆç«¯å£æ£€æµ‹è€—æ—¶â‰ˆå®žé™…æ¡æ‰‹å»¶è¿Ÿï¼‰
                  delay = round((time.time() - start_time) * 1000)  # è½¬æ¯«ç§’
                  return (proxy, delay) if delay < MAX_DELAY else (proxy, float('inf'))
                  
              except Exception as e:
                  return (proxy, float('inf'))

          # 3. å¹¶å‘æµ‹é€Ÿï¼ˆé¿å…å•çº¿ç¨‹å¤ªæ…¢ï¼‰
          print(f"ðŸš€ å¼€å§‹å®žæµ‹ {len(all_trojan)} ä¸ªèŠ‚ç‚¹å»¶è¿Ÿï¼ˆå¹¶å‘æ•°ï¼š{MAX_WORKERS}ï¼‰")
          valid_nodes = []
          
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
              futures = [executor.submit(test_trojan_delay, node) for node in all_trojan]
              for future in as_completed(futures):
                  proxy, delay = future.result()
                  if delay < MAX_DELAY:
                      proxy['delay'] = delay  # ç»™èŠ‚ç‚¹æ·»åŠ å»¶è¿Ÿå±žæ€§
                      valid_nodes.append(proxy)
                      print(f"âœ… æœ‰æ•ˆèŠ‚ç‚¹ï¼š{proxy.get('name')} - å»¶è¿Ÿ {delay}ms")
                  else:
                      print(f"âŒ æ— æ•ˆèŠ‚ç‚¹ï¼š{proxy.get('name')} - è¶…æ—¶/å»¶è¿Ÿè¿‡é«˜")

          print(f"\nâœ… å®žæµ‹å®Œæˆï¼Œå…± {len(valid_nodes)} ä¸ªæœ‰æ•ˆ Trojan èŠ‚ç‚¹")

          # 4. æŒ‰åœ°åŒºç­›é€‰
          regions = {
              'hk': {'keywords': ['é¦™æ¸¯', 'HK', 'hk'], 'file': 'sub_trojan_hk.yaml'},
              'jp': {'keywords': ['æ—¥æœ¬', 'JP', 'jp'], 'file': 'sub_trojan_jp.yaml'},
              'sg': {'keywords': ['æ–°åŠ å¡', 'SG', 'sg'], 'file': 'sub_trojan_sg.yaml'}
          }

          for region, info in regions.items():
              # ç­›é€‰å¯¹åº”åœ°åŒº+æŒ‰å»¶è¿ŸæŽ’åº
              filtered = []
              for p in valid_nodes:
                  name = p.get('name', '').lower()
                  if any(kw in name or kw.lower() in name for kw in info['keywords']):
                      filtered.append(p)
              
              # æŒ‰å»¶è¿Ÿä»Žå°åˆ°å¤§æŽ’åº
              filtered.sort(key=lambda x: x.get('delay', MAX_DELAY))
              final_nodes = filtered[:MAX_PROXIES]

              # æž„å»ºè®¢é˜…æ–‡ä»¶ï¼ˆç§»é™¤delayå±žæ€§ï¼Œç¬¦åˆClashæ ¼å¼ï¼‰
              for node in final_nodes:
                  node.pop('delay', None)
              
              output = {
                  'proxies': final_nodes,
                  'proxy-groups': [{
                      'name': f'Auto-{region.upper()}-Trojan',
                      'type': 'url-test',
                      'proxies': [p['name'] for p in final_nodes],
                      'url': 'http://www.gstatic.com/generate_204',
                      'interval': 300
                  }]
              }

              # ä¿å­˜æ–‡ä»¶
              with open(info['file'], 'w', encoding='utf-8') as f:
                  yaml.dump(output, f, allow_unicode=True, sort_keys=False)
              print(f"\nðŸ“„ ç”Ÿæˆ {info['file']} - ä¿ç•™ {len(final_nodes)} ä¸ªä½Žå»¶è¿ŸèŠ‚ç‚¹")
          EOF

          # æ‰§è¡Œè„šæœ¬
          python gen.py

      - name: Commit all files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Trojan (HK/JP/SG) with real speed test ðŸš€"
          file_pattern: "sub_trojan_*.yaml"
          commit_options: "--allow-empty"
          push_options: "--force"
