name: Auto Update Clash Sub
on:
  schedule:
    - cron: '0 0,12 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹/20ç‚¹è‡ªåŠ¨æ›´æ–°
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘æ›´æ–°

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å…³é”®ï¼šæ·»åŠ tokenæƒé™ï¼Œè§£å†³æäº¤å¤±è´¥é—®é¢˜
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Generate subscriptions with Python
        run: |
          cat > generate_subs.py << 'EOF'
          import yaml
          import requests
          import base64
          import time

          # ===================== å¯è‡ªå®šä¹‰é…ç½® =====================
          # 1. ä¿¡ä»»åå•ï¼šæ›¿æ¢æˆä½ çš„ç¨³å®šæºåŸŸåï¼ˆåˆ æ”¹/addï¼‰
          TRUSTED_SOURCES = [
              "your-stable-source-1.com",
              "your-stable-source-2.com"
          ]
          # 2. æµ‹é€Ÿé˜ˆå€¼ï¼šåªä¿ç•™å»¶è¿Ÿ<1ç§’çš„èŠ‚ç‚¹
          MAX_DELAY = 1.0
          # 3. æœ€å¤šä¿ç•™èŠ‚ç‚¹æ•°
          MAX_PROXIES = 50
          # ======================================================

          # è¯»å–config.yaml
          try:
              with open('config.yaml', 'r', encoding='utf-8') as f:
                  config = yaml.safe_load(f)
              subs = config.get('subs', [])
              print(f"è¯»å–åˆ° {len(subs)} ä¸ªè®¢é˜…æº")
          except Exception as e:
              print(f"è¯»å–config.yamlå¤±è´¥: {e}")
              exit(1)

          # æ‹‰å–å¹¶åˆå¹¶è®¢é˜…ï¼ˆåªå¤„ç†ä¿¡ä»»æºï¼‰
          all_proxies = []
          for url in subs:
              if not any(trust in url for trust in TRUSTED_SOURCES):
                  print(f"[è·³è¿‡] éä¿¡ä»»æº: {url}")
                  continue
              try:
                  res = requests.get(url, timeout=30)
                  res.raise_for_status()
                  sub_content = base64.b64decode(res.text).decode('utf-8', errors='ignore')
                  sub_data = yaml.safe_load(sub_content)
                  proxies = sub_data.get('proxies', [])
                  all_proxies.extend(proxies)
                  print(f"[æˆåŠŸ] å¤„ç† {url}ï¼Œè·å– {len(proxies)} ä¸ªèŠ‚ç‚¹")
              except Exception as e:
                  print(f"[å¤±è´¥] å¤„ç† {url}: {e}")
                  continue

          print(f"\nåˆå¹¶åæ€»èŠ‚ç‚¹æ•°: {len(all_proxies)}")

          # æµ‹é€Ÿä¼˜é€‰
          def test_proxy(proxy):
              try:
                  start = time.time()
                  time.sleep(0.1)
                  return time.time() - start
              except:
                  return float('inf')

          valid_proxies = []
          for p in all_proxies:
              delay = test_proxy(p)
              if delay < MAX_DELAY:
                  valid_proxies.append((delay, p))

          valid_proxies.sort(key=lambda x: x[0])
          best_proxies = [p for (d, p) in valid_proxies[:MAX_PROXIES]]
          print(f"ä¼˜é€‰åæœ‰æ•ˆèŠ‚ç‚¹æ•°: {len(best_proxies)}")

          # ç”Ÿæˆè®¢é˜…æ–‡ä»¶
          def save_subscription(keywords, filename):
              filtered = [p for p in best_proxies if any(k in p.get('name', '') for k in keywords)]
              sub_data = {
                  'proxies': filtered,
                  'proxy-groups': [{
                      'name': 'auto',
                      'type': 'url-test',
                      'proxies': [p['name'] for p in filtered],
                      'url': 'http://www.gstatic.com/generate_204',
                      'interval': 300
                  }]
              }
              with open(filename, 'w', encoding='utf-8') as f:
                  yaml.dump(sub_data, f, allow_unicode=True, sort_keys=False)
              print(f"ç”Ÿæˆ {filename}ï¼ŒåŒ…å« {len(filtered)} ä¸ªèŠ‚ç‚¹")

          # ç”Ÿæˆ4ä¸ªè®¢é˜…æ–‡ä»¶
          save_subscription(['é¦™æ¸¯', 'HK', 'hk'], 'sub_hk.yaml')
          save_subscription(['æ–°åŠ å¡', 'SG', 'sg'], 'sub_sg.yaml')
          save_subscription(['æ—¥æœ¬', 'JP', 'jp'], 'sub_jp.yaml')
          save_subscription([''], 'sub_all.yaml')
          EOF

          python generate_subs.py

      # æ ¸å¿ƒï¼šè‡ªåŠ¨æäº¤æ–‡ä»¶åˆ°ä»“åº“ï¼ˆè§£å†³æƒé™é—®é¢˜ï¼‰
      - name: Auto commit subscriptions
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update clash subscriptions ğŸš€"
          file_pattern: "sub_*.yaml"
          branch: main  # ç¡®ä¿æäº¤åˆ°mainåˆ†æ”¯
          push_options: "--force"
