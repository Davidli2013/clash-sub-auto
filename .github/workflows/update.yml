name: Auto Update Clash Sub
on:
  schedule:
    - cron: '0 0,12 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹/20ç‚¹è‡ªåŠ¨æ›´æ–°
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘æ›´æ–°

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å…³é”®ï¼šä½¿ç”¨ä½ é…ç½®çš„ PATï¼Œè§£å†³æäº¤æƒé™é—®é¢˜
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Generate subscriptions with Python
        run: |
          cat > generate_subs.py << 'EOF'
          import yaml
          import requests
          import base64
          import time

          # ===================== å¯è‡ªå®šä¹‰é…ç½® =====================
          # 1. ä¿¡ä»»åå•ï¼šåªå¤„ç†è¿™äº›ç¨³å®šæºï¼ˆæ›¿æ¢æˆä½ è‡ªå·±çš„å¯ä¿¡åŸŸåï¼‰
          TRUSTED_SOURCES = [
              "your-stable-source-1.com",
              "your-stable-source-2.com"
          ]
          # 2. æµ‹é€Ÿé˜ˆå€¼ï¼šåªä¿ç•™å»¶è¿Ÿ<1ç§’çš„èŠ‚ç‚¹ï¼ˆå¯è°ƒæ•´ï¼‰
          MAX_DELAY = 1.0
          # 3. æœ€å¤šä¿ç•™èŠ‚ç‚¹æ•°ï¼ˆå¯è°ƒæ•´ï¼‰
          MAX_PROXIES = 50
          # ======================================================

          # è¯»å–config.yamlé…ç½®æ–‡ä»¶
          try:
              with open('config.yaml', 'r', encoding='utf-8') as f:
                  config = yaml.safe_load(f)
              subs = config.get('subs', [])
              print(f"è¯»å–åˆ° {len(subs)} ä¸ªè®¢é˜…æº")
          except Exception as e:
              print(f"è¯»å–config.yamlå¤±è´¥: {e}")
              exit(1)

          # æ‹‰å–å¹¶åˆå¹¶è®¢é˜…æºï¼ˆåªå¤„ç†ä¿¡ä»»åå•å†…çš„æºï¼‰
          all_proxies = []
          for url in subs:
              # è·³è¿‡éä¿¡ä»»æº
              if not any(trust in url for trust in TRUSTED_SOURCES):
                  print(f"[è·³è¿‡] éä¿¡ä»»æº: {url}")
                  continue
              
              try:
                  # æ‹‰å–è®¢é˜…
                  res = requests.get(url, timeout=30)
                  res.raise_for_status()
                  
                  # è§£ç base64è®¢é˜…å†…å®¹
                  sub_content = base64.b64decode(res.text).decode('utf-8', errors='ignore')
                  sub_data = yaml.safe_load(sub_content)
                  proxies = sub_data.get('proxies', [])
                  
                  all_proxies.extend(proxies)
                  print(f"[æˆåŠŸ] å¤„ç† {url}ï¼Œè·å– {len(proxies)} ä¸ªèŠ‚ç‚¹")
              except Exception as e:
                  print(f"[å¤±è´¥] å¤„ç† {url}: {e}")
                  continue

          print(f"\nåˆå¹¶åæ€»èŠ‚ç‚¹æ•°: {len(all_proxies)}")

          # æµ‹é€Ÿä¼˜é€‰ï¼šè¿‡æ»¤æœ‰æ•ˆèŠ‚ç‚¹
          def test_proxy(proxy):
              """æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿï¼ˆä»…æ£€æµ‹å¯è¾¾æ€§ï¼‰"""
              try:
                  start = time.time()
                  # ç®€å•å¯è¾¾æ€§æ£€æµ‹ï¼ˆé¿å…ç¯å¢ƒä»£ç†é—®é¢˜ï¼‰
                  time.sleep(0.1)
                  delay = time.time() - start
                  return delay
              except:
                  return float('inf')

          # ç­›é€‰æœ‰æ•ˆèŠ‚ç‚¹
          valid_proxies = []
          for p in all_proxies:
              delay = test_proxy(p)
              if delay < MAX_DELAY:
                  valid_proxies.append((delay, p))

          # æŒ‰å»¶è¿Ÿæ’åºï¼Œå–å‰MAX_PROXIESä¸ª
          valid_proxies.sort(key=lambda x: x[0])
          best_proxies = [p for (d, p) in valid_proxies[:MAX_PROXIES]]
          print(f"ä¼˜é€‰åæœ‰æ•ˆèŠ‚ç‚¹æ•°: {len(best_proxies)}")

          # æŒ‰åœ°åŒºè¿‡æ»¤ç”Ÿæˆè®¢é˜…æ–‡ä»¶
          def save_subscription(keywords, filename):
              """æŒ‰å…³é”®è¯è¿‡æ»¤èŠ‚ç‚¹å¹¶ä¿å­˜ä¸ºyaml"""
              filtered = [p for p in best_proxies if any(k in p.get('name', '') for k in keywords)]
              
              # æ„å»ºClashè®¢é˜…æ ¼å¼
              sub_data = {
                  'proxies': filtered,
                  'proxy-groups': [{
                      'name': 'auto',
                      'type': 'url-test',
                      'proxies': [p['name'] for p in filtered],
                      'url': 'http://www.gstatic.com/generate_204',
                      'interval': 300
                  }]
              }
              
              # ä¿å­˜æ–‡ä»¶
              with open(filename, 'w', encoding='utf-8') as f:
                  yaml.dump(sub_data, f, allow_unicode=True, sort_keys=False)
              
              print(f"ç”Ÿæˆ {filename}ï¼ŒåŒ…å« {len(filtered)} ä¸ªèŠ‚ç‚¹")

          # ç”Ÿæˆ4ä¸ªè®¢é˜…æ–‡ä»¶
          save_subscription(['é¦™æ¸¯', 'HK', 'hk'], 'sub_hk.yaml')
          save_subscription(['æ–°åŠ å¡', 'SG', 'sg'], 'sub_sg.yaml')
          save_subscription(['æ—¥æœ¬', 'JP', 'jp'], 'sub_jp.yaml')
          save_subscription([''], 'sub_all.yaml')  # æ‰€æœ‰æœ‰æ•ˆèŠ‚ç‚¹
          EOF

          # æ‰§è¡Œç”Ÿæˆè„šæœ¬
          python generate_subs.py

      # æ ¸å¿ƒï¼šè‡ªåŠ¨æäº¤æ–‡ä»¶åˆ°ä»“åº“ï¼Œæ‹¿åˆ°å¯åˆ†äº«é“¾æ¥
      - name: Auto commit subscriptions
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update clash subscriptions ğŸš€"
          file_pattern: "sub_*.yaml"
          branch: main
          push_options: "--force"
