name: Auto Update Trojan (HK/JP/SG)
on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动更新
  workflow_dispatch:        # 手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests urllib3

      - name: Generate Trojan Subscriptions
        run: |
          cat > gen.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # 读取配置
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg['subs']
          max_delay = cfg.get('global_filter', {}).get('max_delay', 150) / 1000

          # 拉取所有 Trojan 节点
          all_trojan = []
          for url in subs:
              try:
                  r = requests.get(url, timeout=20, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':  # 只保留 Trojan 协议
                              all_trojan.append(p)
              except Exception as e:
                  continue

          # 去重
          seen_names = set()
          unique_trojan = []
          for p in all_trojan:
              name = p.get('name')
              if name and name not in seen_names:
                  seen_names.add(name)
                  unique_trojan.append(p)

          # 定义地区筛选规则
          regions = {
              'hk': {'keywords': ['香港', 'HK', 'hk'], 'file': 'sub_trojan_hk.yaml'},
              'jp': {'keywords': ['日本', 'JP', 'jp'], 'file': 'sub_trojan_jp.yaml'},
              'sg': {'keywords': ['新加坡', 'SG', 'sg'], 'file': 'sub_trojan_sg.yaml'}
          }

          # 生成各地区订阅文件
          for region, info in regions.items():
              # 筛选对应地区节点
              filtered = []
              for p in unique_trojan:
                  name = p.get('name', '').lower()
                  if any(kw in name or kw.lower() in name for kw in info['keywords']):
                      filtered.append(p)
              
              # 构建订阅格式
              output = {
                  'proxies': filtered[:50],  # 最多保留50个节点
                  'proxy-groups': [{
                      'name': f'Auto-{region.upper()}-Trojan',
                      'type': 'url-test',
                      'proxies': [p['name'] for p in filtered[:50]],
                      'url': 'http://www.gstatic.com/generate_204',
                      'interval': 300
                  }]
              }

              # 保存文件
              with open(info['file'], 'w', encoding='utf-8') as f:
                  yaml.dump(output, f, allow_unicode=True, sort_keys=False)
              print(f"✅ {info['file']} - 生成 {len(filtered)} 个节点")
          EOF

          # 执行脚本
          python gen.py

      - name: Commit all files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Trojan (HK/JP/SG) subscriptions"
          file_pattern: "sub_trojan_*.yaml"
