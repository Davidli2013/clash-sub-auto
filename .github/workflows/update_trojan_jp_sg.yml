name: Auto Update JP/SG Trojan (Weekly, 300 Nodes Pool)
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥UTC 0ç‚¹æ›´æ–°ï¼ˆå¯¹åº”å†…åœ°8ç‚¹ï¼‰
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘å…œåº•

jobs:
  update_jp_sg:
    runs-on: ubuntu-latest
    timeout-minutes: 10   # é˜²æ­¢è„šæœ¬å¡æ­»
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests urllib3

      - name: Generate JP/SG Trojan (300 Nodes)
        run: |
          cat > gen_jp_sg.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # æ ¸å¿ƒé…ç½®ï¼šæ¯ä¸ªåœ°åŒºä¿ç•™300ä¸ªåŽ»é‡èŠ‚ç‚¹ï¼Œåªç­›é€‰ä¸æµ‹é€Ÿ
          MAX_PROXIES = 300
          JP_KEYWORDS = ['æ—¥æœ¬', 'JP', 'jp', 'ä¸œäº¬', 'Tokyo']
          SG_KEYWORDS = ['æ–°åŠ å¡', 'SG', 'sg', 'Singapore']

          # 1. è¯»å–è®¢é˜…æº
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg.get('subs', [])
          if not subs:
              print("âŒ æ— è®¢é˜…æºï¼Œé€€å‡º")
              exit(0)

          all_trojan = []
          seen_nodes = set()

          # 2. æå–TrojanèŠ‚ç‚¹ï¼ˆä»…åŽ»é‡ï¼Œä¸æµ‹é€Ÿï¼‰
          for url in subs:
              try:
                  r = requests.get(url, timeout=30, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              # åŽ»é‡è§„åˆ™ï¼šæœåŠ¡å™¨+ç«¯å£+å¯†ç 
                              server = p.get('server', '')
                              port = str(p.get('port', ''))
                              password = p.get('password', '')
                              if server and port and password:
                                  key = f"{server}:{port}:{password}"
                                  if key not in seen_nodes:
                                      seen_nodes.add(key)
                                      # æ¸…ç†Karingä¸å…¼å®¹å­—æ®µ
                                      clean_p = {k: v for k, v in p.items() if k not in ['delay', 'client-fingerprint']}
                                      all_trojan.append(clean_p)
              except Exception as e:
                  print(f"è®¢é˜…æº {url} å¤„ç†å¤±è´¥: {str(e)[:50]}")
                  continue

          # 3. åˆ†åˆ«ç­›é€‰æ—¥æœ¬/æ–°åŠ å¡èŠ‚ç‚¹
          jp_nodes = [p for p in all_trojan if any(kw.lower() in p.get('name','').lower() for kw in JP_KEYWORDS)]
          sg_nodes = [p for p in all_trojan if any(kw.lower() in p.get('name','').lower() for kw in SG_KEYWORDS)]
          
          # 4. å„ä¿ç•™å‰300ä¸ªï¼ˆè¶³å¤Ÿå¤‡ç”¨åœºæ™¯ä½¿ç”¨ï¼‰
          jp_final = jp_nodes[:MAX_PROXIES]
          sg_final = sg_nodes[:MAX_PROXIES]

          print(f"âœ… æ—¥æœ¬ï¼šæå–{len(jp_nodes)}ä¸ª â†’ ä¿ç•™{len(jp_final)}ä¸ªï¼ˆ300ä¸Šé™ï¼‰")
          print(f"âœ… æ–°åŠ å¡ï¼šæå–{len(sg_nodes)}ä¸ª â†’ ä¿ç•™{len(sg_final)}ä¸ªï¼ˆ300ä¸Šé™ï¼‰")

          # 5. ç”ŸæˆKaringå…¼å®¹çš„çº¯èŠ‚ç‚¹æ–‡ä»¶
          def write_file(nodes, filename):
              output = {'proxies': nodes}
              with open(filename, 'w', encoding='utf-8') as f:
                  yaml.dump(output, f, allow_unicode=True, sort_keys=False)

          write_file(jp_final, 'sub_trojan_jp.yaml')
          write_file(sg_final, 'sub_trojan_sg.yaml')
          EOF

          python gen_jp_sg.py

      - name: Commit JP/SG files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update JP/SG Trojan (weekly, 300 nodes) ðŸ›¡ï¸"
          file_pattern: "sub_trojan_jp.yaml sub_trojan_sg.yaml"
          commit_options: "--allow-empty"
          push_options: "--force"
          branch: main
