name: Auto Update JP/SG Nodes (Weekly, Trojan First)
on:
  schedule:
    - cron: '0 0 * * 0'   # æ¯å‘¨æ—¥æ›´æ–°
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  update_jp_sg:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests urllib3 base64

      - name: Generate JP/SG Nodes (Trojan First)
        run: |
          cat > gen_jp_sg.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # é…ç½®ï¼šæ—¥/æ–°Trojanä¼˜å…ˆï¼Œå…¼å®¹é€šç”¨åè®®
          MAX_JP_NODES = 20
          MAX_SG_NODES = 20
          JP_KEYWORDS = ['æ—¥æœ¬', 'JP', 'jp', 'ä¸œäº¬', 'Tokyo', 'tokyo', 'Japan', 'japan']
          SG_KEYWORDS = ['æ–°åŠ å¡', 'SG', 'sg', 'Singapore', 'singapore']
          # åè®®ä¼˜å…ˆçº§ï¼šTrojan > VMess > Shadowsocks
          PROTOCOL_PRIORITY = ['trojan', 'vmess', 'shadowsocks']

          # è¯»å–è®¢é˜…é“¾æ¥
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg.get('subs', [])
          if not subs:
              print("âŒ æ— è®¢é˜…é“¾æ¥ï¼")
              exit(0)

          # æå–èŠ‚ç‚¹ + å»é‡ + æŒ‰åè®®æ’åº
          all_nodes = []
          seen_nodes = set()

          for idx, url in enumerate(subs):
              print(f"å¤„ç†è®¢é˜… {idx+1}/{len(subs)}: {url}")
              try:
                  r = requests.get(url, timeout=30, verify=False)
                  try:
                      content = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      content = r.text
                  
                  data = yaml.safe_load(content)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          node_type = p.get('type')
                          if node_type not in PROTOCOL_PRIORITY:
                              continue
                          # å»é‡ï¼šä¸åŒåè®®æ ¸å¿ƒä¿¡æ¯
                          if node_type == 'trojan':
                              key = f"{p.get('server')}:{p.get('port')}:{p.get('password')}"
                          elif node_type == 'vmess':
                              key = f"{p.get('server')}:{p.get('port')}:{p.get('id')}"
                          elif node_type == 'shadowsocks':
                              key = f"{p.get('server')}:{p.get('port')}:{p.get('password')}"
                          else:
                              continue
                          
                          if key not in seen_nodes and key.strip():
                              seen_nodes.add(key)
                              # æ ‡è®°ä¼˜å…ˆçº§ï¼Œæ–¹ä¾¿æ’åº
                              p['_priority'] = PROTOCOL_PRIORITY.index(node_type)
                              clean_p = {k: v for k, v in p.items() if k not in ['delay', 'client-fingerprint']}
                              all_nodes.append(clean_p)
              except Exception as e:
                  print(f"è®¢é˜… {url} å¤„ç†å¤±è´¥: {str(e)[:50]}")
                  continue

          # æŒ‰åè®®ä¼˜å…ˆçº§æ’åºï¼ˆTrojanä¼˜å…ˆï¼‰
          all_nodes.sort(key=lambda x: x['_priority'])
          for p in all_nodes:
              p.pop('_priority', None)

          # ç­›é€‰æ—¥/æ–°èŠ‚ç‚¹
          jp_nodes = [p for p in all_nodes if any(kw in p.get('name','').lower() for kw in JP_KEYWORDS)]
          sg_nodes = [p for p in all_nodes if any(kw in p.get('name','').lower() for kw in SG_KEYWORDS)]

          # é™åˆ¶æ•°é‡
          jp_final = jp_nodes[:MAX_JP_NODES]
          sg_final = sg_nodes[:MAX_SG_NODES]

          # ç”Ÿæˆæ–‡ä»¶
          def write_sub(nodes, filename):
              output = {'proxies': nodes}
              with open(filename, 'w', encoding='utf-8') as f:
                  yaml.dump(output, f, allow_unicode=True, sort_keys=False)

          write_sub(jp_final, 'sub_trojan_jp.yaml')
          write_sub(sg_final, 'sub_trojan_sg.yaml')

          print(f"âœ… æ—¥æœ¬èŠ‚ç‚¹ï¼ˆTrojanä¼˜å…ˆï¼‰ï¼š{len(jp_final)} ä¸ªï¼ˆæœ€å¤š20ä¸ªï¼‰")
          print(f"âœ… æ–°åŠ å¡èŠ‚ç‚¹ï¼ˆTrojanä¼˜å…ˆï¼‰ï¼š{len(sg_final)} ä¸ªï¼ˆæœ€å¤š20ä¸ªï¼‰")
          EOF

          python gen_jp_sg.py

      - name: Commit files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update JP/SG nodes (Trojan first) ğŸš€"
          file_pattern: "sub_trojan_jp.yaml sub_trojan_sg.yaml"
          commit_options: "--allow-empty"
          push_options: "--force"
          branch: main
