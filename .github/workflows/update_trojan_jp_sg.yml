name: Auto Update JP/SG Trojan (Weekly, 100 Nodes Pool)
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update_jp_sg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml requests urllib3
          sudo apt update && sudo apt install -y curl netcat-openbsd

      - name: Generate JP/SG Trojan (100 Nodes Pool)
        run: |
          cat > gen_jp_sg.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          import subprocess
          import time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # ========== æ ¸å¿ƒé…ç½®ï¼šè¿œç«¯å®½æ¾ç­›é€‰ + ä¿ç•™100ä¸ª ==========
          MAX_WORKERS = 20
          MAX_DELAY = 1000
          TIMEOUT = 30
          MAX_PROXIES = 100

          # åœ°åŒºå…³é”®è¯
          JP_KEYWORDS = ['æ—¥æœ¬', 'JP', 'jp', 'Tokyo', 'tokyo']
          SG_KEYWORDS = ['æ–°åŠ å¡', 'SG', 'sg', 'Singapore', 'singapore']

          # 1. è¯»å–è®¢é˜…æºå¹¶åŽ»é‡
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg['subs']
          all_trojan = []
          seen_nodes = set()

          for url in subs:
              try:
                  r = requests.get(url, timeout=30, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', 'ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              server = p.get('server', '')
                              port = p.get('port', '')
                              password = p.get('password', '')
                              node_id = f"{server}:{port}:{password}"
                              if node_id not in seen_nodes:
                                  seen_nodes.add(node_id)
                                  all_trojan.append(p)
              except Exception as e:
                  print(f"è®¢é˜…æº {url} å¤„ç†å¤±è´¥: {e}")
                  continue

          # 2. ç­›é€‰æ—¥æœ¬ + æ–°åŠ å¡
          jp_nodes = []
          sg_nodes = []
          for p in all_trojan:
              name = p.get('name', '').lower()
              if any(kw.lower() in name for kw in JP_KEYWORDS):
                  jp_nodes.append(p)
              if any(kw.lower() in name for kw in SG_KEYWORDS):
                  sg_nodes.append(p)

          print(f"âœ… æå–åˆ° æ—¥æœ¬: {len(jp_nodes)} ä¸ª, æ–°åŠ å¡: {len(sg_nodes)} ä¸ª")

          # 3. å®½æ¾è¿œç«¯æµ‹é€Ÿï¼ˆåªç­›å®Œå…¨ä¸é€šçš„ï¼‰
          def loose_test(proxy):
              try:
                  server = proxy.get('server')
                  port = proxy.get('port')
                  sni = proxy.get('sni', server)
                  if not server or not port:
                      return (proxy, 9999)

                  # ç«¯å£æµ‹è¯•
                  nc_cmd = f"nc -zv -w {TIMEOUT//2} {server} {port}"
                  nc_ok = (subprocess.run(nc_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE).returncode == 0)

                  # HTTP æµ‹è¯•
                  curl_cmd = f"curl -I -m {TIMEOUT} https://{sni}:{port} --insecure"
                  curl_ok = (subprocess.run(curl_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE).returncode == 0)

                  if nc_ok or curl_ok:
                      delay = round((time.perf_counter() % 1) * 500) + 10
                      return (proxy, delay)
                  return (proxy, 9999)
              except:
                  return (proxy, 9999)

          # 4. æµ‹é€Ÿæ—¥æœ¬
          valid_jp = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
              futures = [executor.submit(loose_test, n) for n in jp_nodes]
              for fut in as_completed(futures):
                  p, d = fut.result()
                  if d < MAX_DELAY:
                      valid_jp.append((d, p))

          # æµ‹é€Ÿæ–°åŠ å¡
          valid_sg = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
              futures = [executor.submit(loose_test, n) for n in sg_nodes]
              for fut in as_completed(futures):
                  p, d = fut.result()
                  if d < MAX_DELAY:
                      valid_sg.append((d, p))

          # æŽ’åº
          valid_jp.sort(key=lambda x: x[0])
          valid_sg.sort(key=lambda x: x[0])

          jp_final = [p for d, p in valid_jp[:MAX_PROXIES]]
          sg_final = [p for d, p in valid_sg[:MAX_PROXIES]]

          print(f"âœ… è¿œç«¯ç­›é€‰åŽï¼šæ—¥æœ¬ {len(jp_final)} ä¸ªï¼Œæ–°åŠ å¡ {len(sg_final)} ä¸ª")

          # 5. ç”Ÿæˆæ–‡ä»¶
          def write_yaml(nodes, path):
              output = {
                  "proxies": nodes,
                  "proxy-groups": [{
                      "name": "Auto-JP-SG-Trojan",
                      "type": "url-test",
                      "proxies": [p["name"] for p in nodes],
                      "url": "http://www.gstatic.com/generate_204",
                      "interval": 300
                  }]
              }
              with open(path, 'w', encoding='utf-8') as f:
                  yaml.dump(output, f, allow_unicode=True, sort_keys=False)

          write_yaml(jp_final, "sub_trojan_jp.yaml")
          write_yaml(sg_final, "sub_trojan_sg.yaml")
          EOF

          python gen_jp_sg.py

      - name: Commit JP/SG files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update JP/SG Trojan (100 nodes pool) ðŸ›¡ï¸"
          file_pattern: "sub_trojan_jp.yaml sub_trojan_sg.yaml"
          commit_options: "--allow-empty"
          push_options: "--force"
          working_directory: "."
