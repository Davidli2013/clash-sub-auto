name: Auto Update HK Trojan Nodes

# è§¦å‘æ¡ä»¶ï¼šæ¯2å°æ—¶è‡ªåŠ¨è¿è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # èµ‹äºˆå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. é…ç½® Python ç¯å¢ƒï¼ˆå®Œå…¨ç§»é™¤cacheé…ç½®ï¼Œç¦ç”¨ç¼“å­˜ï¼‰
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # ç§»é™¤ cache è¿™ä¸€è¡Œ

      # 3. å®‰è£…å¿…è¦ä¾èµ–
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests ping3 pysocks

      # 4. åˆ›å»ºç›®å½•å¹¶ä¸‹è½½ä»£ç†æº
      - name: Download proxy sources
        run: |
          mkdir -p sources
          # ä¸‹è½½å¤šä¸ªå…è´¹ä»£ç†æºï¼ˆå¢åŠ å¯ç”¨æ€§ï¼‰
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-core/main/data/trojan" -o sources/trojan.txt || echo "Trojan source download failed"
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-core/main/data/vmess" -o sources/vmess.txt || echo "Vmess source download failed"
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-free/main/list" -o sources/v2ray-free.txt || echo "V2ray free source download failed"
          curl -sSL "https://raw.githubusercontent.com/posiehxiunjun/v2ray/main/cf" -o sources/v2rayng.txt || echo "V2rayNG source download failed"
          curl -sSL "https://raw.githubusercontent.com/jiangxufeng/freev2ray/main/freev2ray" -o sources/jiangxufeng.txt || echo "Jiangxufeng source download failed"

      # 5. ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹ + æµ‹è¯•å¯ç”¨æ€§ + ç”Ÿæˆé…ç½®æ–‡ä»¶
      - name: Filter and test HK nodes
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import random
          import socket
          import requests
          from ping3 import ping
          from typing import List, Dict, Tuple

          # ========== é…ç½®é¡¹ ==========
          MAX_NODES = 60  # ä¿ç•™æœ€ä¼˜èŠ‚ç‚¹æ•°é‡
          TIMEOUT = 10    # æµ‹è¯•è¶…æ—¶æ—¶é—´(ç§’)
          TEST_URL = "http://www.google.com/generate_204"  # å¯ç”¨æ€§æµ‹è¯•åœ°å€
          # ===========================

          class ProxyNode:
              """ä»£ç†èŠ‚ç‚¹æ•°æ®ç±»"""
              def __init__(self, proxy_dict: Dict):
                  self.name = proxy_dict.get("name", f"HK_{random.randint(1000,9999)}")
                  self.type = proxy_dict.get("type", "trojan")
                  self.server = proxy_dict.get("server", "")
                  self.port = proxy_dict.get("port", 443)
                  self.password = proxy_dict.get("password", "")
                  self.sni = proxy_dict.get("sni", "")
                  self.skip_cert_verify = proxy_dict.get("skip-cert-verify", True)
                  self.udp = proxy_dict.get("udp", True)
                  self.network = proxy_dict.get("network", "tcp")
                  self.latency = 9999.0  # å»¶è¿Ÿ(ms)
                  self.available = False  # æ˜¯å¦å¯ç”¨

              def to_dict(self) -> Dict:
                  """è½¬æ¢ä¸ºClashé…ç½®å­—å…¸"""
                  base = {
                      "name": self.name,
                      "type": self.type,
                      "server": self.server,
                      "port": self.port,
                      "password": self.password,
                      "skip-cert-verify": self.skip_cert_verify,
                      "udp": self.udp
                  }
                  if self.sni:
                      base["sni"] = self.sni
                  if self.network != "tcp":
                      base["network"] = self.network
                  return base

          def load_proxies_from_files(source_dir: str) -> List[Dict]:
              """ä»ä¸‹è½½çš„æºæ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰ä»£ç†èŠ‚ç‚¹"""
              all_proxies = []
              for filename in os.listdir(source_dir):
                  if not filename.endswith('.txt'):
                      continue
                  filepath = os.path.join(source_dir, filename)
                  try:
                      with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                          content = f.read()
                          # å°è¯•è§£æYAMLæ ¼å¼çš„ä»£ç†åˆ—è¡¨
                          if content.strip():
                              data = yaml.safe_load(content)
                              if isinstance(data, dict) and "proxies" in data:
                                  all_proxies.extend(data["proxies"])
                              elif isinstance(data, list):
                                  all_proxies.extend(data)
                  except Exception as e:
                      print(f"è§£ææ–‡ä»¶ {filename} å¤±è´¥: {str(e)[:100]}")
                      continue
              return all_proxies

          def filter_hk_nodes(proxy_dicts: List[Dict]) -> List[ProxyNode]:
              """ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹"""
              hk_keywords = ["hk", "hongkong", "é¦™æ¸¯", "ğŸ‡­ğŸ‡°", "HK", "HongKong"]
              hk_nodes = []
              for proxy in proxy_dicts:
                  if not proxy or not isinstance(proxy, dict):
                      continue
                  # ä»åç§°/æœåŠ¡å™¨åœ°å€ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹
                  name = str(proxy.get("name", "")).lower()
                  server = str(proxy.get("server", "")).lower()
                  has_hk_keyword = any(kw.lower() in name or kw.lower() in server for kw in hk_keywords)
                  if has_hk_keyword:
                      hk_nodes.append(ProxyNode(proxy))
              return hk_nodes

          def test_node_availability(node: ProxyNode) -> None:
              """æµ‹è¯•èŠ‚ç‚¹å¯ç”¨æ€§å’Œå»¶è¿Ÿ"""
              try:
                  # 1. è§£ææœåŠ¡å™¨IPï¼ˆå¤„ç†åŸŸåï¼‰
                  ip = socket.gethostbyname(node.server)
                  # 2. æµ‹è¯•Pingå»¶è¿Ÿ
                  ping_result = ping(ip, timeout=TIMEOUT)
                  if ping_result:
                      node.latency = round(ping_result * 1000, 2)  # è½¬æ¢ä¸ºms
                  # 3. æµ‹è¯•ä»£ç†å¯ç”¨æ€§ï¼ˆä»…æµ‹è¯•TrojanèŠ‚ç‚¹ï¼‰
                  if node.type == "trojan":
                      test_proxy = {
                          "http": f"socks5://{ip}:{node.port}",
                          "https": f"socks5://{ip}:{node.port}"
                      }
                      response = requests.get(
                          TEST_URL,
                          proxies=test_proxy,
                          timeout=TIMEOUT,
                          verify=not node.skip_cert_verify
                      )
                      if response.status_code == 204:
                          node.available = True
              except Exception:
                  node.available = False

          def main():
              # 1. åŠ è½½æ‰€æœ‰ä»£ç†èŠ‚ç‚¹
              all_proxy_dicts = load_proxies_from_files("sources")
              print(f"åŠ è½½åˆ°åŸå§‹èŠ‚ç‚¹æ€»æ•°: {len(all_proxy_dicts)}")
              
              # 2. ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹
              hk_nodes = filter_hk_nodes(all_proxy_dicts)
              print(f"ç­›é€‰å‡ºé¦™æ¸¯èŠ‚ç‚¹æ•°é‡: {len(hk_nodes)}")
              
              # 3. æµ‹è¯•èŠ‚ç‚¹å¯ç”¨æ€§
              print("å¼€å§‹æµ‹è¯•èŠ‚ç‚¹å¯ç”¨æ€§...")
              available_nodes = []
              for i, node in enumerate(hk_nodes):
                  if i % 10 == 0:
                      print(f"å·²æµ‹è¯• {i}/{len(hk_nodes)} ä¸ªèŠ‚ç‚¹")
                  test_node_availability(node)
                  if node.available and node.latency < 500:  # ä»…ä¿ç•™å»¶è¿Ÿ<500msçš„å¯ç”¨èŠ‚ç‚¹
                      available_nodes.append(node)
              
              # 4. æŒ‰å»¶è¿Ÿæ’åºï¼Œä¿ç•™æœ€ä¼˜èŠ‚ç‚¹
              available_nodes.sort(key=lambda x: x.latency)
              best_nodes = available_nodes[:MAX_NODES]
              print(f"æœ€ç»ˆä¿ç•™æœ€ä¼˜èŠ‚ç‚¹æ•°é‡: {len(best_nodes)}")
              
              # 5. ç”Ÿæˆå®Œæ•´çš„Clashé…ç½®æ–‡ä»¶
              clash_config = {
                  "mixed-port": 7890,
                  "allow-lan": True,
                  "mode": "Rule",
                  "log-level": "info",
                  "external-controller": "127.0.0.1:9090",
                  "proxies": [node.to_dict() for node in best_nodes],
                  "proxy-groups": [
                      {
                          "name": "é¦™æ¸¯èŠ‚ç‚¹ä¼˜é€‰",
                          "type": "url-test",
                          "proxies": [n.name for n in best_nodes],
                          "url": TEST_URL,
                          "interval": 300
                      },
                      {
                          "name": "è‡ªåŠ¨é€‰æ‹©",
                          "type": "select",
                          "proxies": ["é¦™æ¸¯èŠ‚ç‚¹ä¼˜é€‰", "DIRECT"]
                      }
                  ],
                  "rules": [
                      "GEOIP,CN,DIRECT",
                      "MATCH,é¦™æ¸¯èŠ‚ç‚¹ä¼˜é€‰"
                  ]
              }
              
              # 6. å†™å…¥é…ç½®æ–‡ä»¶
              with open("sub_trojan_hk.yaml", "w", encoding="utf-8") as f:
                  yaml.dump(
                      clash_config,
                      f,
                      default_flow_style=False,
                      allow_unicode=True,
                      sort_keys=False
                  )
              print("é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ: sub_trojan_hk.yaml")

          if __name__ == "__main__":
              main()
          EOF

      # 6. æäº¤å¹¶æ¨é€æ›´æ–°ï¼ˆè§£å†³æƒé™é—®é¢˜ï¼‰
      - name: Commit and push changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}  # ä½¿ç”¨ä½ é…ç½®çš„PATå¯†é’¥
        run: |
          # é…ç½®Gitèº«ä»½
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          git add sub_trojan_hk.yaml
          if git diff --cached --quiet; then
              echo "æ²¡æœ‰èŠ‚ç‚¹æ›´æ–°ï¼Œæ— éœ€æäº¤"
              exit 0
          fi
          
          # æäº¤å¹¶æ¨é€
          git commit -m "Auto update HK Trojan nodes (pure) ğŸš€"
          git push https://${GH_PAT}@github.com/Davidli2013/clash-sub-auto.git HEAD:main
          echo "èŠ‚ç‚¹é…ç½®å·²æˆåŠŸæ¨é€è‡³ä»“åº“"
