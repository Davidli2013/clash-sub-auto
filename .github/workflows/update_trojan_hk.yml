name: Auto Update HK Trojan (4x/day, Filter+Deduplicate)
on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 6 * * *'
    - cron: '0 12 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  update_hk:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests urllib3

      - name: Generate HK Trojan
        run: |
          cat > gen_hk.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          import os
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          MAX_PROXIES = 100
          FILTER_KEYWORDS = ['é¦™æ¸¯', 'HK', 'hk']

          if not os.path.exists('config.yaml'):
              print("âŒ æ‰¾ä¸åˆ°config.yaml")
              exit(1)

          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg.get('subs', [])
          if not subs:
              print("âŒ æ²¡æœ‰è®¢é˜…æº")
              exit(1)

          all_trojan = []
          seen_nodes = set()

          for url in subs:
              try:
                  r = requests.get(url, timeout=30, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', 'ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              server = p.get('server', '')
                              port = str(p.get('port', ''))
                              password = p.get('password', '')
                              if server and port and password:
                                  key = f"{server}:{port}:{password}"
                                  if key not in seen_nodes:
                                      seen_nodes.add(key)
                                      all_trojan.append(p)
              except Exception as e:
                  print(f"è®¢é˜…æº {url} å¤±è´¥: {e}")
                  continue

          hk_nodes = [p for p in all_trojan if any(kw.lower() in p.get('name','').lower() for kw in FILTER_KEYWORDS)]
          final_nodes = hk_nodes[:MAX_PROXIES]

          output = {
              'proxies': final_nodes,
              'proxy-groups': [{
                  'name': 'Auto-HK-Trojan',
                  'type': 'url-test',
                  'proxies': [p.get('name', f'HK-{i}') for i, p in enumerate(final_nodes)],
                  'url': 'http://www.gstatic.com/generate_204',
                  'interval': 300
              }]
          }
          with open('sub_trojan_hk.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(output, f, allow_unicode=True, sort_keys=False)
          EOF

          python gen_hk.py

      - name: Commit & Push HK File
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[Auto] Update HK Trojan Nodes ğŸš€"
          file_pattern: "sub_trojan_hk.yaml"
          commit_options: "--allow-empty --no-verify"
          push_options: "--force"
          branch: main
