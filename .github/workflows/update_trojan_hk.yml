name: Update Trojan HK YAML

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml requests

      - name: Download all sources
        run: |
          mkdir -p sources
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-core/main/data/trojan" -o sources/trojan.txt || true
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-core/main/data/vmess" -o sources/vmess.txt || true
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-core/main/data/ss" -o sources/ss.txt || true
          curl -sSL "https://raw.githubusercontent.com/freev2ray/free-v2ray-free/main/list" -o sources/v2ray-free.txt || true
          curl -sSL "https://raw.githubusercontent.com/posiehxiunjun/v2ray/main/cf" -o sources/v2rayng.txt || true

      - name: Run filter script
        run: |
          python3 << 'EOF'
          import os
          import yaml

          def parse_proxies(content):
              try:
                  data = yaml.safe_load(content)
                  if data and 'proxies' in data:
                      return data['proxies']
              except:
                  pass
              return []

          def filter_hk(proxies):
              keywords = ['hk', 'hongkong', 'é¦™æ¸¯', 'HK']
              filtered = []
              for p in proxies:
                  name = p.get('name', '').lower()
                  server = p.get('server', '').lower()
                  for kw in keywords:
                      if kw.lower() in name or kw.lower() in server:
                          filtered.append(p)
                          break
              return filtered

          all_proxies = []
          for filename in os.listdir('sources'):
              if filename.endswith('.txt'):
                  filepath = os.path.join('sources', filename)
                  try:
                      with open(filepath, 'r', encoding='utf-8') as f:
                          content = f.read()
                          proxies = parse_proxies(content)
                          all_proxies.extend(proxies)
                  except Exception as e:
                      print(f"Error reading {filename}: {e}")

          hk_proxies = filter_hk(all_proxies)
          print(f"Found {len(hk_proxies)} HK proxies")

          # ä¿ç•™æœ€å¥½çš„50ä¸ªï¼ˆè¿™é‡Œå…ˆç®€å•å–å‰50ï¼Œå¯åŽç»­åŠ å…¥æµ‹é€Ÿé€»è¾‘ï¼‰
          best_hk_proxies = hk_proxies[:50]

          # å†™å›ž YAML æ–‡ä»¶
          output_config = {
              "proxies": best_hk_proxies
          }

          with open('sub_trojan_hk.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(output_config, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git add sub_trojan_hk.yaml
          git commit -m "Auto update HK Trojan nodes (pure) ðŸš€" || echo "No changes to commit"
          git push
