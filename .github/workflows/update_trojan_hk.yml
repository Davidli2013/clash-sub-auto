name: Auto Update HK Trojan (4x/day, 100 Nodes Pool)
on:
  schedule:
    - cron: '0 0,6,12,18 * * *'  # åŒ—äº¬æ—¶é—´8/14/20/2ç‚¹æ›´æ–°
  workflow_dispatch:            # æ‰‹åŠ¨è§¦å‘

jobs:
  update_hk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml requests urllib3
          sudo apt update && sudo apt install -y curl netcat-openbsd

      - name: Generate HK Trojan (100 Nodes Pool)
        run: |
          cat > gen_hk.py << 'EOF'
          import yaml
          import requests
          import base64
          import urllib3
          import subprocess
          import time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # ========== æ ¸å¿ƒé…ç½®ï¼ˆé€‚é…è¿œç«¯+æœ¬åœ°åŒé‡ç­›é€‰ï¼‰ ==========
          MAX_WORKERS = 20          # æ›´é«˜å¹¶å‘ï¼Œè¦†ç›–æ›´å¤šèŠ‚ç‚¹
          MAX_DELAY = 1000          # è¿œç«¯å»¶è¿Ÿæ”¾å®½åˆ°1000msï¼ˆåªç­›å®Œå…¨ä¸å¯ç”¨çš„ï¼‰
          TIMEOUT = 30              # è¶…æ—¶å»¶é•¿åˆ°30ç§’
          MAX_PROXIES = 100         # è¿œç«¯ä¿ç•™å‰100ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ï¼ˆç»™æœ¬åœ°ç•™è¶³ç©ºé—´ï¼‰
          FILTER_KEYWORDS = ['é¦™æ¸¯', 'HK', 'hk']  # ç­›é€‰å…³é”®è¯

          # 1. è¯»å–è®¢é˜…æºï¼Œæå–æ‰€æœ‰TrojanèŠ‚ç‚¹ï¼ˆå»é‡ï¼‰
          with open('config.yaml', 'r', encoding='utf-8') as f:
              cfg = yaml.safe_load(f)
          subs = cfg['subs']
          all_trojan = []
          seen_nodes = set()

          for url in subs:
              try:
                  r = requests.get(url, timeout=30, verify=False)
                  try:
                      txt = base64.b64decode(r.text).decode('utf-8', errors='ignore')
                  except:
                      txt = r.text
                  data = yaml.safe_load(txt)
                  if 'proxies' in data:
                      for p in data['proxies']:
                          if p.get('type') == 'trojan':
                              server = p.get('server', '')
                              port = p.get('port', '')
                              password = p.get('password', '')
                              node_id = f"{server}:{port}:{password}"
                              if node_id not in seen_nodes:
                                  seen_nodes.add(node_id)
                                  all_trojan.append(p)
              except Exception as e:
                  print(f"å¤„ç†è®¢é˜…æº {url} å¤±è´¥: {e}")
                  continue

          # 2. ç­›é€‰é¦™æ¸¯èŠ‚ç‚¹
          hk_nodes = []
          for p in all_trojan:
              name = p.get('name', '').lower()
              if any(kw in name for kw in FILTER_KEYWORDS):
                  hk_nodes.append(p)
          print(f"âœ… æå–åˆ° {len(hk_nodes)} ä¸ªé¦™æ¸¯TrojanèŠ‚ç‚¹")

          # 3. è¿œç«¯å®½æ¾æµ‹é€Ÿï¼ˆåªç­›æ‰å®Œå…¨ä¸å¯ç”¨çš„èŠ‚ç‚¹ï¼‰
          def loose_remote_test(proxy):
              """
              è¿œç«¯å®½æ¾éªŒè¯ï¼šåªè¦ç«¯å£é€š OR HTTPå¯è¾¾ï¼Œå°±åˆ¤å®šä¸ºå€™é€‰èŠ‚ç‚¹
              ä¸ä¸¥æ ¼å¡å»¶è¿Ÿï¼ŒåªåšåŸºç¡€è¿é€šæ€§éªŒè¯
              """
              try:
                  server = proxy.get('server')
                  port = proxy.get('port')
                  sni = proxy.get('sni', server)
                  if not server or not port:
                      return (proxy, 9999)  # å…œåº•å»¶è¿Ÿï¼Œæ’åé¢
                  
                  # éªŒè¯1ï¼šç«¯å£è¿é€šæ€§
                  nc_cmd = f"nc -zv -w {TIMEOUT//2} {server} {port}"
                  nc_result = subprocess.run(
                      nc_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE
                  )
                  
                  # éªŒè¯2ï¼šHTTPå¯è¾¾æ€§
                  curl_cmd = f"curl -I -m {TIMEOUT} https://{sni}:{port} --insecure"
                  curl_result = subprocess.run(
                      curl_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE
                  )
                  
                  # åªè¦ä¸€ä¸ªéªŒè¯é€šè¿‡ï¼Œå°±ç®—å€™é€‰èŠ‚ç‚¹
                  if nc_result.returncode == 0 or curl_result.returncode == 0:
                      # è®¡ç®—åŸºç¡€å»¶è¿Ÿï¼ˆç”¨äºæ’åºï¼Œä¸ç­›é™¤ï¼‰
                      start = time.time()
                      delay = round((time.time() - start) * 1000)
                      return (proxy, min(delay, MAX_DELAY))
                  return (proxy, 9999)
              except Exception as e:
                  return (proxy, 9999)

          # 4. å¹¶å‘æµ‹é€Ÿï¼Œæ”¶é›†æ‰€æœ‰å€™é€‰èŠ‚ç‚¹
          candidate_nodes = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
              futures = {executor.submit(loose_remote_test, p): p for p in hk_nodes}
              for future in as_completed(futures):
                  proxy, delay = future.result()
                  proxy['remote_delay'] = delay  # æ ‡è®°è¿œç«¯å»¶è¿Ÿï¼Œæ–¹ä¾¿æœ¬åœ°å‚è€ƒ
                  candidate_nodes.append(proxy)

          # 5. æŒ‰è¿œç«¯å»¶è¿Ÿæ’åºï¼Œä¿ç•™å‰100ä¸ªå€™é€‰èŠ‚ç‚¹
          candidate_nodes.sort(key=lambda x: x.get('remote_delay', 9999))
          final_nodes = candidate_nodes[:MAX_PROXIES]
          
          # ç§»é™¤è¿œç«¯å»¶è¿Ÿæ ‡è®°ï¼Œç¬¦åˆClashæ ‡å‡†æ ¼å¼
          for node in final_nodes:
              node.pop('remote_delay', None)

          print(f"âœ… è¿œç«¯ç­›é€‰å‡º {len(final_nodes)} ä¸ªå€™é€‰èŠ‚ç‚¹ï¼ˆä¿ç•™å‰100ä¸ªï¼‰")

          # 6. ç”Ÿæˆè®¢é˜…æ–‡ä»¶ï¼ˆåŒ…å«url-testï¼Œæœ¬åœ°è‡ªåŠ¨äºŒæ¬¡ç­›é€‰ï¼‰
          output_data = {
              'proxies': final_nodes,
              'proxy-groups': [{
                  'name': 'Auto-HK-Trojan',
                  'type': 'url-test',
                  'proxies': [p['name'] for p in final_nodes],
                  'url': 'http://www.gstatic.com/generate_204',
                  'interval': 300,  # æœ¬åœ°æ¯5åˆ†é’Ÿè‡ªåŠ¨æµ‹é€Ÿä¸€æ¬¡
                  'tolerance': 50   # æœ¬åœ°æµ‹é€Ÿå®¹å·®ï¼Œæ›´ç²¾å‡†
              }]
          }

          with open('sub_trojan_hk.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(output_data, f, allow_unicode=True, sort_keys=False)
          print(f"âœ… ç”Ÿæˆé¦™æ¸¯Trojanæ–‡ä»¶ï¼Œå…± {len(final_nodes)} ä¸ªå€™é€‰èŠ‚ç‚¹")
          EOF

          python gen_hk.py

      - name: Commit HK file
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update HK Trojan (100 nodes pool) ğŸš€"
          file_pattern: "sub_trojan_hk.yaml"
          commit_options: "--allow-empty"
          push_options: "--force"
          working_directory: "."
