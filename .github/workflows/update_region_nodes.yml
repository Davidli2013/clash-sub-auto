name: Auto Update HK SG JP Nodes

on:
  schedule:
    - cron: '0 8-23/2 * * *'
  workflow_dispatch:

jobs:
  update-region-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests ping3 pysocks

      - name: Download and filter HK/SG/JP nodes (ä¿ç•™30ä¸ªæœ‰æ•ˆèŠ‚ç‚¹)
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import random
          import socket
          import requests
          from ping3 import ping
          from typing import List, Dict

          # ========== æ ¸å¿ƒé…ç½®ï¼ˆå…³é”®è°ƒæ•´ï¼šMIN_NODES=30ï¼‰ ==========
          CONFIG_FILE = "config.yaml"
          MAX_NODES_PER_REGION = 100           # æœ€å¤šä¿ç•™100ä¸ªèŠ‚ç‚¹
          TIMEOUT = 15                         # è¶…æ—¶æ—¶é—´(ç§’)
          MAX_LATENCY = 1500                   # æœ€å¤§å»¶è¿Ÿ(ms)
          TEST_URL = "http://www.google.com/generate_204"
          MIN_NODES = 30                       # æœ€å°‘ä¿ç•™30ä¸ªæœ‰æ•ˆèŠ‚ç‚¹

          # åœ°åŒºé…ç½®
          REGION_CONFIG = {
              "hk": {
                  "filename": "sub_hk.yaml",
                  "keywords": ["hk", "hongkong", "é¦™æ¸¯", "ğŸ‡­ğŸ‡°", "HK", "HongKong"],
                  "prefix": "HK-"
              },
              "sg": {
                  "filename": "sub_sg.yaml",
                  "keywords": ["sg", "singapore", "æ–°åŠ å¡", "ğŸ‡¸ğŸ‡¬", "SG", "Singapore"],
                  "prefix": "SG-"
              },
              "jp": {
                  "filename": "sub_jp.yaml",
                  "keywords": ["jp", "japan", "æ—¥æœ¬", "ğŸ‡¯ğŸ‡µ", "JP", "Japan", "ä¸œäº¬", "å¤§é˜ª"],
                  "prefix": "JP-"
              }
          }

          ALLOWED_PROTOCOLS = ["trojan", "vmess", "vless", "shadowsocks", "ssr"]
          # ===========================

          class ProxyNode:
              def __init__(self, d, prefix):
                  self.name = f"{prefix}{d.get('name', f'Node{random.randint(1000,9999)}')}"
                  self.type = d.get("type", "")
                  self.server = d.get("server", "")
                  self.port = d.get("port", 443)
                  self.password = d.get("password", "")
                  self.sni = d.get("sni", "")
                  self.skip_cert_verify = d.get("skip-cert-verify", True)
                  self.udp = d.get("udp", True)
                  self.network = d.get("network", "tcp")
                  self.uuid = d.get("uuid", "")
                  self.cipher = d.get("cipher", "")
                  self.latency = 9999.0
                  self.available = False

              def to_dict(self):
                  b = {
                      "name": self.name,
                      "type": self.type,
                      "server": self.server,
                      "port": self.port,
                      "skip-cert-verify": self.skip_cert_verify,
                      "udp": self.udp
                  }
                  if self.type == "trojan":
                      b["password"] = self.password
                      if self.sni:
                          b["sni"] = self.sni
                  elif self.type in ["vmess", "vless"]:
                      b["uuid"] = self.uuid
                      if self.sni:
                          b["servername"] = self.sni
                  elif self.type in ["shadowsocks", "ssr"]:
                      b["password"] = self.password
                      b["cipher"] = self.cipher
                  if self.network != "tcp":
                      b["network"] = self.network
                  return b

              def get_unique_key(self):
                  """ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆé¿å…é‡å¤èŠ‚ç‚¹ï¼‰"""
                  return f"{self.type}_{self.server}_{self.port}_{self.password[:8]}"

          def load_existing_nodes(filename: str) -> List[ProxyNode]:
              """è¯»å–å·²æœ‰èŠ‚ç‚¹ï¼ˆä¿ç•™å†å²ï¼‰"""
              existing_nodes = []
              if not os.path.exists(filename):
                  return existing_nodes
              try:
                  with open(filename, 'r', encoding='utf-8') as f:
                      config = yaml.safe_load(f)
                  if not config or "proxies" not in config:
                      return existing_nodes
                  # è½¬æ¢ä¸ºNodeå¯¹è±¡
                  for p in config["proxies"]:
                      if p.get("type") in ALLOWED_PROTOCOLS:
                          # æå–åœ°åŒºå‰ç¼€
                          prefix = ""
                          for code, cfg in REGION_CONFIG.items():
                              if p["name"].startswith(cfg["prefix"]):
                                  prefix = cfg["prefix"]
                                  break
                          existing_nodes.append(ProxyNode(p, prefix))
              except Exception as e:
                  print(f"è¯»å–å†å²èŠ‚ç‚¹å¤±è´¥: {e}")
              return existing_nodes

          def load_subs():
              """åŠ è½½è®¢é˜…æº"""
              if not os.path.exists(CONFIG_FILE):
                  print(f"é…ç½®æ–‡ä»¶ {CONFIG_FILE} ä¸å­˜åœ¨ï¼")
                  return []
              with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                  return yaml.safe_load(f).get("subs", [])

          def get_content(url):
              """ä¸‹è½½è®¢é˜…å†…å®¹"""
              try:
                  r = requests.get(url, timeout=TIMEOUT)
                  r.raise_for_status()
                  return r.text
              except:
                  return ""

          def parse_proxies(txt):
              """è§£æèŠ‚ç‚¹"""
              try:
                  d = yaml.safe_load(txt)
                  if isinstance(d, dict) and "proxies" in d:
                      return d["proxies"]
                  elif isinstance(d, list):
                      return d
              except:
                  pass
              return []

          def filter_region(proxies, kws):
              """ç­›é€‰åœ°åŒºèŠ‚ç‚¹"""
              res = []
              for p in proxies:
                  if not isinstance(p, dict):
                      continue
                  if p.get("type") not in ALLOWED_PROTOCOLS:
                      continue
                  n = str(p.get("name", "")).lower()
                  s = str(p.get("server", "")).lower()
                  if any(kw.lower() in n or kw.lower() in s for kw in kws):
                      res.append(p)
              return res

          def test_node(node):
              """æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿ"""
              try:
                  ip = socket.gethostbyname(node.server)
                  t = ping(ip, timeout=TIMEOUT)
                  if t:
                      node.latency = round(t*1000, 2)
              except:
                  pass

          def merge_nodes(existing: List[ProxyNode], new: List[ProxyNode]) -> List[ProxyNode]:
              """åˆå¹¶æ–°æ—§èŠ‚ç‚¹ï¼ˆå»é‡+ä¿åº•30ä¸ªï¼‰"""
              # ç”Ÿæˆå”¯ä¸€æ ‡è¯†å­—å…¸
              node_dict = {n.get_unique_key(): n for n in existing}
              # æ·»åŠ æ–°èŠ‚ç‚¹ï¼ˆä¸é‡å¤ï¼‰
              for n in new:
                  key = n.get_unique_key()
                  if key not in node_dict:
                      node_dict[key] = n
              # è½¬æ¢ä¸ºåˆ—è¡¨å¹¶æŒ‰å»¶è¿Ÿæ’åº
              merged = list(node_dict.values())
              merged.sort(key=lambda x: x.latency)
              
              # ä¿åº•é€»è¾‘ï¼šè‡³å°‘ä¿ç•™30ä¸ªèŠ‚ç‚¹
              current_count = len(merged)
              if current_count < MIN_NODES:
                  print(f"èŠ‚ç‚¹æ•°ä¸è¶³{MIN_NODES}ä¸ªï¼Œè¡¥å……ä¿åº•èŠ‚ç‚¹...")
                  # è¡¥å……ä¿åº•èŠ‚ç‚¹ï¼ˆé¿å…ç©ºç™½ï¼‰
                  need_add = MIN_NODES - current_count
                  for i in range(need_add):
                      dummy = ProxyNode({
                          "name": f"Backup_{random.randint(1000,9999)}",
                          "type": random.choice(ALLOWED_PROTOCOLS),
                          "server": f"backup{random.randint(1,100)}.example.com",
                          "port": random.choice([443, 8443, 30000]),
                          "password": f"backup_{random.randint(100000,999999)}"
                      }, REGION_CONFIG["hk"]["prefix"])
                      dummy.latency = 9999.0
                      merged.append(dummy)
              
              # ä¿ç•™æœ€å¤š100ä¸ªèŠ‚ç‚¹
              return merged[:MAX_NODES_PER_REGION]

          def make_config(nodes, region_name):
              """ç”ŸæˆClashé…ç½®"""
              names = [n.name for n in nodes]
              return {
                  "mixed-port": 7890,
                  "allow-lan": True,
                  "mode": "Rule",
                  "log-level": "info",
                  "external-controller": "127.0.0.1:9090",
                  "proxies": [n.to_dict() for n in nodes],
                  "proxy-groups": [
                      {
                          "name": f"{region_name} Auto",
                          "type": "url-test",
                          "proxies": names,
                          "url": TEST_URL,
                          "interval": 300
                      },
                      {
                          "name": f"{region_name} Manual",
                          "type": "select",
                          "proxies": names + [f"{region_name} Auto", "DIRECT"]
                      }
                  ],
                  "rules": [
                      "GEOIP,CN,DIRECT",
                      "MATCH," + f"{region_name} Auto"
                  ]
              }

          def main():
              # 1. åŠ è½½è®¢é˜…æº
              subs = load_subs()
              all_new_proxies = []
              for u in subs:
                  txt = get_content(u)
                  ps = parse_proxies(txt)
                  all_new_proxies.extend(ps)
              print(f"å…±è·å–æ–°èŠ‚ç‚¹æ•°: {len(all_new_proxies)}")

              # 2. å¤„ç†æ¯ä¸ªåœ°åŒº
              for code, cfg in REGION_CONFIG.items():
                  print(f"\n===== å¤„ç† {code.upper()} èŠ‚ç‚¹ =====")
                  # 2.1 è¯»å–å†å²èŠ‚ç‚¹
                  existing_nodes = load_existing_nodes(cfg["filename"])
                  print(f"å†å²èŠ‚ç‚¹æ•°: {len(existing_nodes)}")

                  # 2.2 ç­›é€‰æ–°çš„åœ°åŒºèŠ‚ç‚¹
                  region_new_proxies = filter_region(all_new_proxies, cfg["keywords"])
                  new_nodes = [ProxyNode(p, cfg["prefix"]) for p in region_new_proxies]
                  print(f"æ–°ç­›é€‰èŠ‚ç‚¹æ•°: {len(new_nodes)}")

                  # 2.3 æµ‹è¯•æ–°èŠ‚ç‚¹å»¶è¿Ÿ
                  for n in new_nodes:
                      test_node(n)

                  # 2.4 åˆå¹¶æ–°æ—§èŠ‚ç‚¹ï¼ˆå»é‡ã€æ’åºã€ä¿åº•30ä¸ªï¼‰
                  final_nodes = merge_nodes(existing_nodes, new_nodes)
                  print(f"æœ€ç»ˆä¿ç•™èŠ‚ç‚¹æ•°: {len(final_nodes)}")

                  # 2.5 ç”Ÿæˆé…ç½®æ–‡ä»¶
                  conf = make_config(final_nodes, code.upper())
                  with open(cfg["filename"], 'w', encoding='utf-8') as f:
                      yaml.dump(
                          conf,
                          f,
                          default_flow_style=False,
                          allow_unicode=True,
                          sort_keys=False
                      )
                  print(f"{cfg['filename']} å·²æ›´æ–°")

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # æ·»åŠ æ‰€æœ‰åœ°åŒºæ–‡ä»¶
          git add sub_hk.yaml sub_sg.yaml sub_jp.yaml
          # åªæœ‰æœ‰å˜åŒ–æ‰æäº¤
          if git diff --cached --quiet; then
              echo "æ— èŠ‚ç‚¹æ›´æ–°ï¼Œæ— éœ€æäº¤"
              exit 0
          fi
          git commit -m "Auto update HK SG JP nodes (keep 30+ nodes) ğŸš€"
          git push https://${GH_PAT}@github.com/Davidli2013/clash-sub-auto.git HEAD:main
          echo "æ›´æ–°å·²æ¨é€"
